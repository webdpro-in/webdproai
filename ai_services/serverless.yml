service: webdpro-ai-services

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-north-1  # Business logic in Stockholm
  memorySize: 1024
  timeout: 300  # 5 minutes for AI generation
  stage: ${opt:stage, 'dev'}
  
  # Enable X-Ray tracing for monitoring
  tracing:
    lambda: true
    apiGateway: true
  
  # CloudWatch Logs retention
  logRetentionInDays: 7
  
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
    POWERTOOLS_SERVICE_NAME: webdpro-ai-services
    LOG_LEVEL: ${opt:logLevel, 'INFO'}
    
    # Cross-Region Configuration
    AWS_S3_REGION: ${env:AWS_S3_REGION, 'eu-north-1'}
    AWS_S3_BUCKET: ${env:AWS_S3_BUCKET, 'webdpro-ai-storage'}
    AWS_S3_BUCKET_WEBSITES: ${env:AWS_S3_BUCKET_WEBSITES, 'webdpro-websites-ai-gen'}
    AWS_S3_BUCKET_ASSETS: ${env:AWS_S3_BUCKET_ASSETS, 'webdpro-assets-ai-gen'}
    
    AWS_BEDROCK_REGION: ${env:AWS_BEDROCK_REGION, 'us-east-1'}
    AWS_BEDROCK_MODEL_PRIMARY: ${env:AWS_BEDROCK_MODEL_PRIMARY, 'amazon.nova-pro-v1:0'}
    AWS_BEDROCK_MODEL_FALLBACK_1: ${env:AWS_BEDROCK_MODEL_FALLBACK_1, 'anthropic.claude-3-5-haiku-20241022-v1:0'}
    AWS_BEDROCK_MODEL_FALLBACK_2: ${env:AWS_BEDROCK_MODEL_FALLBACK_2, 'anthropic.claude-3-haiku-20240307-v1:0'}
    AWS_BEDROCK_MODEL_IMAGE: ${env:AWS_BEDROCK_MODEL_IMAGE, 'amazon.titan-image-generator-v2:0'}
    AWS_BEDROCK_MODEL_FALLBACK_3: ${env:AWS_BEDROCK_MODEL_FALLBACK_3, 'meta.llama3-2-90b-instruct-v1:0'}
    
    AWS_CORE_REGION: ${env:AWS_CORE_REGION, 'eu-north-1'}

  iam:
    role:
      statements:
        # Bedrock access in us-east-1
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
            - bedrock:InvokeModelWithResponseStream
          Resource: 
            - "arn:aws:bedrock:us-east-1::foundation-model/*"
        
        # S3 access in eu-north-1
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - "arn:aws:s3:::${env:AWS_S3_BUCKET, 'webdpro-ai-storage'}/*"
            - "arn:aws:s3:::${env:AWS_S3_BUCKET_WEBSITES, 'webdpro-websites'}/*"
            - "arn:aws:s3:::${env:AWS_S3_BUCKET_ASSETS, 'webdpro-assets'}/*"
            - "arn:aws:s3:::${env:AWS_S3_BUCKET, 'webdpro-ai-storage'}"
            - "arn:aws:s3:::${env:AWS_S3_BUCKET_WEBSITES, 'webdpro-websites'}"
            - "arn:aws:s3:::${env:AWS_S3_BUCKET_ASSETS, 'webdpro-assets'}"
        
        # X-Ray tracing permissions
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: "*"
        
        # CloudWatch Logs permissions
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:${self:provider.region}:*:*"

functions:
  # AI Website Generation with Cross-Region Support
  generateWebsite:
    handler: src/handlers/generate.generateWebsite
    memorySize: 2048  # Increased for AI processing
    timeout: 300
    events:
      - http:
          path: /ai/generate
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false
    environment:
      FUNCTION_NAME: generateWebsite
      CLOUDFRONT_DOMAIN: !GetAtt WebsitesCDN.DomainName

  # Individual Pipeline Steps
  generateSpec:
    handler: src/handlers/pipeline.generateSpec
    memorySize: 1536
    timeout: 120
    events:
      - http:
          path: /ai/spec
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  generateCode:
    handler: src/handlers/pipeline.generateCode
    memorySize: 1536
    timeout: 120
    events:
      - http:
          path: /ai/code
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  generateImages:
    handler: src/handlers/pipeline.generateImages
    memorySize: 1536
    timeout: 180
    events:
      - http:
          path: /ai/images
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  # Health Check
  ping:
    handler: src/handlers/health.ping
    events:
      - http:
          path: /ai/health
          method: get
          cors: true


resources:
  Resources:
    # CloudWatch Alarm for Lambda errors
    LambdaErrorAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-lambda-errors
        AlarmDescription: Alert on Lambda function errors
        MetricName: Errors
        Namespace: AWS/Lambda
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 5
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
    
    # CloudWatch Alarm for Lambda throttles
    LambdaThrottleAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-lambda-throttles
        AlarmDescription: Alert on Lambda function throttles
        MetricName: Throttles
        Namespace: AWS/Lambda
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 10
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
    
    # S3 Buckets in eu-north-1 (Stockholm)
    AIStorageBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${env:AWS_S3_BUCKET, 'webdpro-ai-storage'}-${self:provider.stage}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ['*']
              AllowedMethods: [GET, PUT, POST, DELETE]
              AllowedOrigins: ['*']
              MaxAge: 3000

    WebsitesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${env:AWS_S3_BUCKET_WEBSITES, 'webdpro-websites'}-${self:provider.stage}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        WebsiteConfiguration:
          IndexDocument: index.html
          ErrorDocument: error.html

    AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${env:AWS_S3_BUCKET_ASSETS, 'webdpro-assets'}-${self:provider.stage}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false

    # Bucket Policies for Public Read Access
    AIStorageBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref AIStorageBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*'
              Action: s3:GetObject
              Resource: !Sub "arn:aws:s3:::${AIStorageBucket}/*"

    AssetsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref AssetsBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*'
              Action: s3:GetObject
              Resource: !Sub "arn:aws:s3:::${AssetsBucket}/*"

    # CloudFront Distribution for Websites
    WebsitesCDN:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Enabled: true
          DefaultRootObject: index.html
          Origins:
            - Id: S3Origin
              DomainName: !GetAtt WebsitesBucket.DomainName
              S3OriginConfig:
                OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${OriginAccessIdentity}"
          DefaultCacheBehavior:
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: [GET, HEAD]
            CachedMethods: [GET, HEAD]
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
          # This allows merchants to map CNAMEs later
          Aliases: [] 
          ViewerCertificate:
            CloudFrontDefaultCertificate: true

    OriginAccessIdentity:
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: "Access S3 bucket content only through CloudFront"

    # Update Bucket Policy to allow CloudFront Access
    WebsitesBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref WebsitesBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                CanonicalUser: !GetAtt OriginAccessIdentity.S3CanonicalUserId
              Action: s3:GetObject
              Resource: !Sub "arn:aws:s3:::${WebsitesBucket}/*"

  Outputs:
    CloudFrontDomain:
      Value: !GetAtt WebsitesCDN.DomainName
      Description: "The CloudFront Domain for Generated Websites"
    AssetsBucketName:
      Value: !Ref AssetsBucket
      Description: "Bucket for static assets"

plugins:
  - serverless-plugin-typescript
  - serverless-offline
  - serverless-dotenv-plugin

custom:
  serverless-plugin-typescript:
    tsConfigFileLocation: './tsconfig.json'
  serverless-offline:
    httpPort: 3002
  dotenv:
    exclude:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_REGION

package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!test/**'