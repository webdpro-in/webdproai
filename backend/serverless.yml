service: webdpro-backend

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-north-1
  memorySize: 256  # Increased for better performance
  timeout: 30      # Increased for AI service calls
  stage: ${opt:stage, 'dev'}
  
  # Enable X-Ray tracing for monitoring
  tracing:
    lambda: true
    apiGateway: true
  
  # CloudWatch Logs retention
  logRetentionInDays: 7
  
  # HTTP API Configuration (API Gateway V2)
  httpApi:
    # CORS Configuration with whitelisted origins (Requirements 7.3, 16.1)
    cors:
      allowedOrigins:
        - http://localhost:3000
        - https://d3qhkomcxcxmtl.cloudfront.net
        - https://ai-gamma-rose.vercel.app
        - https://main.d31s5vazm93jhm.amplifyapp.com
        - https://webdpro.in
        - ${env:FRONTEND_URL, 'http://localhost:3000'}
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Request-ID
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
        - X-Amz-User-Agent
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      maxAge: 3600
      allowCredentials: true
    
    # JWT Authorizer with Cognito (Requirements 7.4, 16.2)
    authorizers:
      cognitoAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: https://cognito-idp.${self:provider.region}.amazonaws.com/${self:custom.cognitoUserPoolId}
        audience:
          - ${self:custom.cognitoClientId}
    
    # Throttling/Rate Limiting (Requirements 7.4, 16.3)
    throttle:
      burstLimit: 100
      rateLimit: 50
  
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
    POWERTOOLS_SERVICE_NAME: webdpro-backend
    LOG_LEVEL: ${opt:logLevel, 'INFO'}
    AWS_S3_REGION: ${env:AWS_S3_REGION, 'eu-north-1'}
    AWS_S3_BUCKET: ${env:AWS_S3_BUCKET, 'webdpro-ai-storage'}
    AWS_BEDROCK_REGION: ${env:AWS_BEDROCK_REGION, 'us-east-1'}
    AWS_CORE_REGION: ${env:AWS_CORE_REGION, 'eu-north-1'}
    DYNAMODB_TABLE_PREFIX: webdpro
    WEBDPRO_RAZORPAY_KEY_ID: ${env:RAZORPAY_KEY_ID, 'test_key'}
    WEBDPRO_RAZORPAY_KEY_SECRET: ${env:RAZORPAY_KEY_SECRET, 'test_secret'}
    EVENTS_TOPIC_ARN: !Ref WebDProEventsTopic
    # PHASE 1: Use production AI service URL with Bedrock enabled
    # PHASE 2: Keep production URL
    AI_SERVICE_URL: ${env:AI_SERVICE_URL, 'https://l0wi495th5.execute-api.eu-north-1.amazonaws.com/dev'}
    AI_USE_BEDROCK: ${env:AI_USE_BEDROCK, 'true'}
    S3_BUCKET: webdpro-ai-storage-dev
    CLOUDFRONT_DISTRIBUTION_ID: ${env:CLOUDFRONT_DISTRIBUTION_ID, ''}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/webdpro-*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/webdpro-*/index/*"
        - Effect: Allow
          Action:
            - sns:Publish
          Resource: !Ref WebDProEventsTopic
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminCreateUser
            - cognito-idp:InitiateAuth
            - cognito-idp:RespondToAuthChallenge
          Resource: "*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:${self:provider.region}:*:log-group:/aws/apigateway/*"
        - Effect: Allow
          Action:
            - acm:RequestCertificate
            - acm:DescribeCertificate
            - acm:ListCertificates
          Resource: "*"
        - Effect: Allow
          Action:
            - cloudfront:CreateDistribution
            - cloudfront:UpdateDistribution
            - cloudfront:GetDistribution
            - cloudfront:CreateInvalidation
          Resource: "*"
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
            - s3:CopyObject
          Resource:
            - "arn:aws:s3:::${self:provider.environment.S3_BUCKET}"
            - "arn:aws:s3:::${self:provider.environment.S3_BUCKET}/*"

package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!test/**'

functions:
  # Auth Functions (Public - no authorizer)
  requestOTP:
    handler: src/handlers/auth.requestOTP
    events:
      - httpApi:
          path: /auth/otp/request
          method: post
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPoolWebDProUserPoolV3
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient

  verifyOTP:
    handler: src/handlers/auth.verifyOTP
    events:
      - httpApi:
          path: /auth/otp/verify
          method: post
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPoolWebDProUserPoolV3
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient

  syncGoogleUser:
    handler: src/handlers/auth.syncGoogleUser
    events:
      - httpApi:
          path: /auth/google/sync
          method: post
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPoolWebDProUserPoolV3
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient

  getProfile:
    handler: src/handlers/auth.getProfile
    events:
      - httpApi:
          path: /auth/profile
          method: get
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPoolWebDProUserPoolV3
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient

  # Cognito Triggers
  defineAuthChallenge:
    handler: src/handlers/auth_triggers.defineAuthChallenge
  
  createAuthChallenge:
    handler: src/handlers/auth_triggers.createAuthChallenge

  verifyAuthChallengeResponse:
    handler: src/handlers/auth_triggers.verifyAuthChallengeResponse

  # Store Functions
  # PHASE 1: Auth completely disabled for local dev testing
  # PHASE 2: Restore cognitoAuthorizer for production
  generateStore:
    handler: src/handlers/stores.generateStore
    timeout: 60
    memorySize: 512
    events:
      - httpApi:
          path: /stores/generate
          method: post
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  getStores:
    handler: src/handlers/stores.getStores
    events:
      - httpApi:
          path: /stores
          method: get
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  getStore:
    handler: src/handlers/stores.getStore
    events:
      - httpApi:
          path: /stores/{storeId}
          method: get
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  publishStore:
    handler: src/handlers/stores.publishStore
    events:
      - httpApi:
          path: /stores/{storeId}/publish
          method: post
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  updateStore:
    handler: src/handlers/stores.updateStore
    events:
      - httpApi:
          path: /stores/{storeId}
          method: put
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  regenerateStore:
    handler: src/handlers/regenerate.regenerateStore
    timeout: 60
    events:
      - httpApi:
          path: /stores/{storeId}/regenerate
          method: post


  # Domain Management
  # PHASE 1: Auth disabled for local dev
  # PHASE 2: Restore cognitoAuthorizer for production
  connectDomain:
    handler: src/handlers/domains.connectDomain
    events:
      - httpApi:
          path: /stores/{storeId}/domain
          method: post
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  getDomainStatus:
    handler: src/handlers/domains.getDomainStatus
    events:
      - httpApi:
          path: /stores/{storeId}/domain/status
          method: get
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  verifyDomain:
    handler: src/handlers/domains.verifyDomain
    events:
      - httpApi:
          path: /stores/{storeId}/domain/verify
          method: post
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  # Order Management
  # PHASE 1: Auth disabled for local dev
  # PHASE 2: Restore cognitoAuthorizer for production
  createOrder:
    handler: src/handlers/orders.createOrder
    events:
      - httpApi:
          path: /stores/{storeId}/orders
          method: post
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  getOrder:
    handler: src/handlers/orders.getOrder
    events:
      - httpApi:
          path: /orders/{orderId}
          method: get
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  getStoreOrders:
    handler: src/handlers/orders.getStoreOrders
    events:
      - httpApi:
          path: /stores/{storeId}/orders
          method: get
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer

  updateOrderStatus:
    handler: src/handlers/orders.updateOrderStatus
    events:
      - httpApi:
          path: /orders/{orderId}/status
          method: put
          # PHASE 2: Uncomment for production
          # authorizer:
          #   name: cognitoAuthorizer


  # Health Check
  ping:
    handler: src/handlers/health.ping
    events:
      - httpApi:
          path: /health
          method: get

plugins:
  - serverless-plugin-typescript
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  serverless-plugin-typescript:
    tsConfigFileLocation: './tsconfig.json'
  userPoolName: webdpro-users-${self:provider.stage}
  # Cognito configuration for JWT authorizer
  cognitoUserPoolId: eu-north-1_RfO53Cz5t
  cognitoClientId: 7g6sqvvnqsg628napds0k73190
  dotenv:
    exclude:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_REGION
  
  # Serverless Offline configuration for local development
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002
    websocketPort: 3003

# Add Gateway Responses to ensure CORS headers on ALL responses including errors
# Note: HTTP API (v2) handles CORS automatically based on httpApi.cors configuration

resources:
  Resources:
    # HTTP API (v2) handles CORS automatically via httpApi.cors configuration
    # No need for manual Gateway Response resources
    
    # CloudWatch Log Group for API Gateway Access Logs (Requirement 16.5)
    HttpApiLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/apigateway/webdpro-backend-${self:provider.stage}
        RetentionInDays: 7
    
    # HTTP API Stage with Access Logging
    HttpApiStage:
      Type: AWS::ApiGatewayV2::Stage
      Properties:
        ApiId: !Ref HttpApi
        StageName: ${self:provider.stage}
        AutoDeploy: true
        AccessLogSettings:
          DestinationArn: !GetAtt HttpApiLogGroup.Arn
          Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","routeKey":"$context.routeKey","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength","integrationLatency":"$context.integrationLatency","responseLatency":"$context.responseLatency","authorizerError":"$context.authorizer.error","integrationError":"$context.integrationErrorMessage"}'
        DefaultRouteSettings:
          ThrottlingBurstLimit: 100
          ThrottlingRateLimit: 50
          DetailedMetricsEnabled: true

    # IAM Role for Cognito SMS
    CognitoSMSRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: cognito-idp.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: CognitoSMSPolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action: sns:publish
                  Resource: "*"

    # Cognito User Pool
    CognitoUserPoolWebDProUserPoolV3:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:custom.userPoolName}
        MfaConfiguration: OFF
        AliasAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Schema:
          - Name: email
            AttributeDataType: String
            Mutable: true
            Required: false
          - Name: phone_number
            AttributeDataType: String
            Mutable: true
            Required: false
          - Name: role
            AttributeDataType: String
            Mutable: true
            Required: false
          - Name: tenant_id
            AttributeDataType: String
            Mutable: true
            Required: false
          - Name: plan
            AttributeDataType: String
            Mutable: true
            Required: false
        LambdaConfig:
          DefineAuthChallenge: !GetAtt DefineAuthChallengeLambdaFunction.Arn
          CreateAuthChallenge: !GetAtt CreateAuthChallengeLambdaFunction.Arn
          VerifyAuthChallengeResponse: !GetAtt VerifyAuthChallengeResponseLambdaFunction.Arn

    # Cognito User Pool Domain (Required for Google Sign-In)
    # Note: Domain already exists, commenting out to avoid conflicts
    # CognitoUserPoolDomainV3:
    #   Type: AWS::Cognito::UserPoolDomain
    #   Properties:
    #     UserPoolId: !Ref CognitoUserPoolWebDProUserPoolV3
    #     Domain: webdpro-auth-${self:provider.stage}-${sls:instanceId}

    # Google Identity Provider
    CognitoUserPoolIdentityProviderGoogle:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId: !Ref CognitoUserPoolWebDProUserPoolV3
        ProviderName: Google
        ProviderDetails:
          client_id: ${env:GOOGLE_CLIENT_ID, 'placeholder-client-id'}
          client_secret: ${env:GOOGLE_CLIENT_SECRET, 'placeholder-client-secret'}
          authorize_scopes: "email profile openid"
        ProviderType: Google
        AttributeMapping:
          email: email
          name: name
          picture: picture

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      DependsOn: CognitoUserPoolIdentityProviderGoogle
      Properties:
        ClientName: webdpro-client
        GenerateSecret: false
        UserPoolId: !Ref CognitoUserPoolWebDProUserPoolV3
        SupportedIdentityProviders:
          - COGNITO
          - Google
        AllowedOAuthFlows:
          - code
        AllowedOAuthScopes:
          - email
          - openid
          - profile
        AllowedOAuthFlowsUserPoolClient: true
        CallbackURLs:
          - http://localhost:3000/auth/callback
          - https://d3qhkomcxcxmtl.cloudfront.net/auth/callback
          - https://ai-gamma-rose.vercel.app/auth/callback
          - https://main.d2bj5ckg0v1gci.amplifyapp.com/auth/callback
          - https://main.d31s5vazm93jhm.amplifyapp.com/auth/callback
          - https://webdpro.in/auth/callback
          - ${env:COGNITO_CALLBACK_URL, 'http://localhost:3000/auth/callback'}
        LogoutURLs:
          - http://localhost:3000
          - https://d3qhkomcxcxmtl.cloudfront.net
          - https://ai-gamma-rose.vercel.app
          - https://main.d2bj5ckg0v1gci.amplifyapp.com
          - https://main.d31s5vazm93jhm.amplifyapp.com
          - https://webdpro.in
          - ${env:COGNITO_LOGOUT_URL, 'http://localhost:3000'}
        ExplicitAuthFlows:
          - ALLOW_CUSTOM_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH

    # SNS Topic
    WebDProEventsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: webdpro-events-${self:provider.stage}

    # DynamoDB Tables
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-users
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: phone
            AttributeType: S
        KeySchema:
          - AttributeName: phone
            KeyType: HASH

    StoresTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-stores
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: store_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: store_id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: store-id-index
            KeySchema:
              - AttributeName: store_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    TenantsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-tenants
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH

    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-orders
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: order_id
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: order_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: tenant-index
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    PaymentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-payments
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: payment_id
            AttributeType: S
        KeySchema:
          - AttributeName: payment_id
            KeyType: HASH

    ProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-products
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: store_id
            AttributeType: S
          - AttributeName: product_id
            AttributeType: S
        KeySchema:
          - AttributeName: store_id
            KeyType: HASH
          - AttributeName: product_id
            KeyType: RANGE

    DeliveryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-delivery
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: delivery_id
            AttributeType: S
          - AttributeName: agent_id
            AttributeType: S
        KeySchema:
          - AttributeName: delivery_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: agent-index
            KeySchema:
              - AttributeName: agent_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL



    # Permissions for Cognito to invoke Lambdas
    DefineAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:InvokeFunction
        FunctionName: !GetAtt DefineAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt CognitoUserPoolWebDProUserPoolV3.Arn

    CreateAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:InvokeFunction
        FunctionName: !GetAtt CreateAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt CognitoUserPoolWebDProUserPoolV3.Arn

    VerifyAuthChallengeResponsePermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:InvokeFunction
        FunctionName: !GetAtt VerifyAuthChallengeResponseLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt CognitoUserPoolWebDProUserPoolV3.Arn

  Outputs:
    UserPoolId:
      Value: !Ref CognitoUserPoolWebDProUserPoolV3
    UserPoolClientId:
      Value: !Ref CognitoUserPoolClient
    EventsTopicArn:
      Value: !Ref WebDProEventsTopic