service: webdpro-backend

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-north-1
  memorySize: 256  # Increased for better performance
  timeout: 30      # Increased for AI service calls
  stage: ${opt:stage, 'dev'}
  
  # Enable X-Ray tracing for monitoring
  tracing:
    lambda: true
    apiGateway: true
  
  # CloudWatch Logs retention
  logRetentionInDays: 7
  
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
    POWERTOOLS_SERVICE_NAME: webdpro-backend
    LOG_LEVEL: ${opt:logLevel, 'INFO'}
    AWS_S3_REGION: ${env:AWS_S3_REGION, 'eu-north-1'}
    AWS_S3_BUCKET: ${env:AWS_S3_BUCKET, 'webdpro-ai-storage'}
    AWS_BEDROCK_REGION: ${env:AWS_BEDROCK_REGION, 'us-east-1'}
    AWS_CORE_REGION: ${env:AWS_CORE_REGION, 'eu-north-1'}
    DYNAMODB_TABLE_PREFIX: webdpro
    WEBDPRO_RAZORPAY_KEY_ID: ${env:RAZORPAY_KEY_ID, 'test_key'}
    WEBDPRO_RAZORPAY_KEY_SECRET: ${env:RAZORPAY_KEY_SECRET, 'test_secret'}
    EVENTS_TOPIC_ARN: !Ref WebDProEventsTopic
    AI_SERVICE_URL: https://l0wi495th5.execute-api.eu-north-1.amazonaws.com/dev
    S3_BUCKET: webdpro-ai-storage-dev
    CLOUDFRONT_DISTRIBUTION_ID: ${env:CLOUDFRONT_DISTRIBUTION_ID, ''}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/webdpro-*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/webdpro-*/index/*"
        - Effect: Allow
          Action:
            - sns:Publish
          Resource: !Ref WebDProEventsTopic
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminCreateUser
            - cognito-idp:InitiateAuth
            - cognito-idp:RespondToAuthChallenge
          Resource: "*"
        - Effect: Allow
          Action:
            - acm:RequestCertificate
            - acm:DescribeCertificate
            - acm:ListCertificates
          Resource: "*"
        - Effect: Allow
          Action:
            - cloudfront:CreateDistribution
            - cloudfront:UpdateDistribution
            - cloudfront:GetDistribution
            - cloudfront:CreateInvalidation
          Resource: "*"
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
            - s3:CopyObject
          Resource:
            - "arn:aws:s3:::${self:provider.environment.S3_BUCKET}"
            - "arn:aws:s3:::${self:provider.environment.S3_BUCKET}/*"

package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!test/**'

functions:
  # CORS Handler for OPTIONS requests
  corsHandler:
    handler: src/handlers/cors.handleOptions
    events:
      - http:
          path: /auth/otp/request
          method: options
      - http:
          path: /auth/otp/verify
          method: options
      - http:
          path: /auth/google/sync
          method: options
      - http:
          path: /auth/profile
          method: options
      - http:
          path: /stores/generate
          method: options
      - http:
          path: /stores
          method: options
      - http:
          path: /stores/{storeId}
          method: options
      - http:
          path: /stores/{storeId}/publish
          method: options
      - http:
          path: /stores/{storeId}/domain
          method: options
      - http:
          path: /stores/{storeId}/domain/status
          method: options
      - http:
          path: /stores/{storeId}/domain/verify
          method: options
      - http:
          path: /stores/{storeId}/orders
          method: options
      - http:
          path: /orders/{orderId}
          method: options
      - http:
          path: /orders/{orderId}/status
          method: options

  # Auth Functions
  requestOTP:
    handler: src/handlers/auth.requestOTP
    events:
      - http:
          path: /auth/otp/request
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPoolWebDProUserPoolV3
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient

  verifyOTP:
    handler: src/handlers/auth.verifyOTP
    events:
      - http:
          path: /auth/otp/verify
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPoolWebDProUserPoolV3
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient

  syncGoogleUser:
    handler: src/handlers/auth.syncGoogleUser
    events:
      - http:
          path: /auth/google/sync
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPoolWebDProUserPoolV3
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient

  getProfile:
    handler: src/handlers/auth.getProfile
    events:
      - http:
          path: /auth/profile
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPoolWebDProUserPoolV3
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient

  # Cognito Triggers
  defineAuthChallenge:
    handler: src/handlers/auth_triggers.defineAuthChallenge
  
  createAuthChallenge:
    handler: src/handlers/auth_triggers.createAuthChallenge

  verifyAuthChallengeResponse:
    handler: src/handlers/auth_triggers.verifyAuthChallengeResponse

  # Store Functions
  generateStore:
    handler: src/handlers/stores.generateStore
    timeout: 29
    memorySize: 512  # Increased for AI service calls
    events:
      - http:
          path: /stores/generate
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  getStores:
    handler: src/handlers/stores.getStores
    events:
      - http:
          path: /stores
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  getStore:
    handler: src/handlers/stores.getStore
    events:
      - http:
          path: /stores/{storeId}
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  publishStore:
    handler: src/handlers/stores.publishStore
    events:
      - http:
          path: /stores/{storeId}/publish
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  updateStore:
    handler: src/handlers/stores.updateStore
    events:
      - http:
          path: /stores/{storeId}
          method: put
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  # Domain Management
  connectDomain:
    handler: src/handlers/domains.connectDomain
    events:
      - http:
          path: /stores/{storeId}/domain
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  getDomainStatus:
    handler: src/handlers/domains.getDomainStatus
    events:
      - http:
          path: /stores/{storeId}/domain/status
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  verifyDomain:
    handler: src/handlers/domains.verifyDomain
    events:
      - http:
          path: /stores/{storeId}/domain/verify
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  # Order Management
  createOrder:
    handler: src/handlers/orders.createOrder
    events:
      - http:
          path: /stores/{storeId}/orders
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  getOrder:
    handler: src/handlers/orders.getOrder
    events:
      - http:
          path: /orders/{orderId}
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  getStoreOrders:
    handler: src/handlers/orders.getStoreOrders
    events:
      - http:
          path: /stores/{storeId}/orders
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  updateOrderStatus:
    handler: src/handlers/orders.updateOrderStatus
    events:
      - http:
          path: /orders/{orderId}/status
          method: put
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

plugins:
  - serverless-plugin-typescript
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  serverless-plugin-typescript:
    tsConfigFileLocation: './tsconfig.json'
  userPoolName: webdpro-users-${self:provider.stage}
  dotenv:
    exclude:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_REGION

# Add Gateway Responses to ensure CORS headers on ALL responses including errors
  gatewayResponses:
    DEFAULT_4XX:
      responseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
    DEFAULT_5XX:
      responseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
    UNAUTHORIZED:
      statusCode: 401
      responseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"

resources:
  Resources:
    # Gateway Responses for CORS on error responses
    GatewayResponseDefault4XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        ResponseType: DEFAULT_4XX
        RestApiId: !Ref ApiGatewayRestApi

    GatewayResponseDefault5XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        ResponseType: DEFAULT_5XX
        RestApiId: !Ref ApiGatewayRestApi

    GatewayResponseUnauthorized:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        ResponseType: UNAUTHORIZED
        RestApiId: !Ref ApiGatewayRestApi
        StatusCode: '401'

    # IAM Role for Cognito SMS
    CognitoSMSRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: cognito-idp.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: CognitoSMSPolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action: sns:publish
                  Resource: "*"

    # Cognito User Pool
    CognitoUserPoolWebDProUserPoolV3:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:custom.userPoolName}
        MfaConfiguration: OFF
        AliasAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Schema:
          - Name: email
            AttributeDataType: String
            Mutable: true
            Required: false
          - Name: phone_number
            AttributeDataType: String
            Mutable: true
            Required: false
          - Name: role
            AttributeDataType: String
            Mutable: true
            Required: false
          - Name: tenant_id
            AttributeDataType: String
            Mutable: true
            Required: false
          - Name: plan
            AttributeDataType: String
            Mutable: true
            Required: false
        LambdaConfig:
          DefineAuthChallenge: !GetAtt DefineAuthChallengeLambdaFunction.Arn
          CreateAuthChallenge: !GetAtt CreateAuthChallengeLambdaFunction.Arn
          VerifyAuthChallengeResponse: !GetAtt VerifyAuthChallengeResponseLambdaFunction.Arn

    # Cognito User Pool Domain (Required for Google Sign-In)
    # Note: Domain already exists, commenting out to avoid conflicts
    # CognitoUserPoolDomainV3:
    #   Type: AWS::Cognito::UserPoolDomain
    #   Properties:
    #     UserPoolId: !Ref CognitoUserPoolWebDProUserPoolV3
    #     Domain: webdpro-auth-${self:provider.stage}-${sls:instanceId}

    # Google Identity Provider
    CognitoUserPoolIdentityProviderGoogle:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId: !Ref CognitoUserPoolWebDProUserPoolV3
        ProviderName: Google
        ProviderDetails:
          client_id: ${env:GOOGLE_CLIENT_ID, 'placeholder-client-id'}
          client_secret: ${env:GOOGLE_CLIENT_SECRET, 'placeholder-client-secret'}
          authorize_scopes: "email profile openid"
        ProviderType: Google
        AttributeMapping:
          email: email
          name: name
          picture: picture

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      DependsOn: CognitoUserPoolIdentityProviderGoogle
      Properties:
        ClientName: webdpro-client
        GenerateSecret: false
        UserPoolId: !Ref CognitoUserPoolWebDProUserPoolV3
        SupportedIdentityProviders:
          - COGNITO
          - Google
        AllowedOAuthFlows:
          - code
        AllowedOAuthScopes:
          - email
          - openid
          - profile
        AllowedOAuthFlowsUserPoolClient: true
        CallbackURLs:
          - http://localhost:3000/auth/callback
          - https://d3qhkomcxcxmtl.cloudfront.net/auth/callback
          - https://ai-gamma-rose.vercel.app/auth/callback
          - ${env:COGNITO_CALLBACK_URL, 'http://localhost:3000/auth/callback'}
        LogoutURLs:
          - http://localhost:3000
          - https://d3qhkomcxcxmtl.cloudfront.net
          - https://ai-gamma-rose.vercel.app
          - ${env:COGNITO_LOGOUT_URL, 'http://localhost:3000'}
        ExplicitAuthFlows:
          - ALLOW_CUSTOM_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH

    # SNS Topic
    WebDProEventsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: webdpro-events-${self:provider.stage}

    # DynamoDB Tables
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-users
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: phone
            AttributeType: S
        KeySchema:
          - AttributeName: phone
            KeyType: HASH

    StoresTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-stores
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: store_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: store_id
            KeyType: RANGE

    TenantsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-tenants
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH

    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-orders
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: order_id
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: order_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: tenant-index
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    PaymentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-payments
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: payment_id
            AttributeType: S
        KeySchema:
          - AttributeName: payment_id
            KeyType: HASH

    ProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-products
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: store_id
            AttributeType: S
          - AttributeName: product_id
            AttributeType: S
        KeySchema:
          - AttributeName: store_id
            KeyType: HASH
          - AttributeName: product_id
            KeyType: RANGE

    DeliveryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: webdpro-delivery
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: delivery_id
            AttributeType: S
          - AttributeName: agent_id
            AttributeType: S
        KeySchema:
          - AttributeName: delivery_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: agent-index
            KeySchema:
              - AttributeName: agent_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL



    # Permissions for Cognito to invoke Lambdas
    DefineAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:InvokeFunction
        FunctionName: !GetAtt DefineAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt CognitoUserPoolWebDProUserPoolV3.Arn

    CreateAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:InvokeFunction
        FunctionName: !GetAtt CreateAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt CognitoUserPoolWebDProUserPoolV3.Arn

    VerifyAuthChallengeResponsePermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:InvokeFunction
        FunctionName: !GetAtt VerifyAuthChallengeResponseLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt CognitoUserPoolWebDProUserPoolV3.Arn

  Outputs:
    UserPoolId:
      Value: !Ref CognitoUserPoolWebDProUserPoolV3
    UserPoolClientId:
      Value: !Ref CognitoUserPoolClient
    EventsTopicArn:
      Value: !Ref WebDProEventsTopic