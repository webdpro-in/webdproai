service: webdpro-inventory

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-north-1
  memorySize: 256
  timeout: 30
  environment:
    DYNAMODB_TABLE_PREFIX: webdpro
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
    EVENTS_TOPIC_ARN: ${env:EVENTS_TOPIC_ARN, 'arn:aws:sns:${self:provider.region}:${aws:accountId}:webdpro-events-${self:provider.stage}'}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_PREFIX}-*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_PREFIX}-*/index/*"
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
            - bedrock:InvokeModelWithResponseStream
          Resource: 
            - "arn:aws:bedrock:us-east-1::foundation-model/*"
        - Effect: Allow
          Action:
            - sns:Publish
          Resource: "${self:provider.environment.EVENTS_TOPIC_ARN}"


package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!test/**'

functions:
  # Health Check
  ping:
    handler: src/handlers/health.ping
    events:
      - http:
          path: /inventory/health
          method: get
          cors: true

  # Product CRUD
  getProducts:
    handler: src/handlers/products.getProducts
    events:
      - http:
          path: /inventory/{storeId}/products
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  createProduct:
    handler: src/handlers/products.createProduct
    events:
      - http:
          path: /inventory/{storeId}/products
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  updateProduct:
    handler: src/handlers/products.updateProduct
    events:
      - http:
          path: /inventory/{storeId}/products/{productId}
          method: put
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  deleteProduct:
    handler: src/handlers/products.deleteProduct
    events:
      - http:
          path: /inventory/{storeId}/products/{productId}
          method: delete
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  # Stock Management
  updateStock:
    handler: src/handlers/stock.updateStock
    events:
      - http:
          path: /inventory/{storeId}/stock/{productId}
          method: put
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  getLowStock:
    handler: src/handlers/stock.getLowStock
    events:
      - http:
          path: /inventory/{storeId}/low-stock
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  # AI Predictions (scheduled)
  predictStock:
    handler: src/handlers/predictions.predictStock
    events:
      - schedule: rate(5 minutes)

  # Event Handlers
  handleEvents:
    handler: src/handlers/events.handleEvents
    events:
      - sns:
          arn: ${self:provider.environment.EVENTS_TOPIC_ARN}
          filterPolicy:
            eventType:
              - ORDER_PLACED
              - ORDER_CANCELLED

resources:
  Outputs:
    WebdproInventoryServiceUrl:
      Value:
        Fn::Join:
          - ""
          - - "https://"
            - Ref: ApiGatewayRestApi
            - ".execute-api.${self:provider.region}.amazonaws.com/${self:provider.stage}"
      Export:
        Name: WebdproInventoryServiceUrl

plugins:
  - serverless-plugin-typescript


custom:
  serverless-plugin-typescript:
    tsConfigFileLocation: './tsconfig.json'
