service: webdpro-payments

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-north-1
  memorySize: 256
  timeout: 30
  environment:
    DYNAMODB_TABLE_PREFIX: webdpro
    RAZORPAY_KEY_ID: ${env:RAZORPAY_KEY_ID, 'test_key'}
    RAZORPAY_KEY_SECRET: ${env:RAZORPAY_KEY_SECRET, 'test_secret'}
    WEBHOOK_SECRET: ${env:RAZORPAY_WEBHOOK_SECRET, 'test_secret'}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_PREFIX}-tenants"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_PREFIX}-orders"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_PREFIX}-orders/index/*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_PREFIX}-payments"

functions:
  # Merchant Onboarding (Linked Accounts)
  createMerchantAccount:
    handler: src/onboarding.createMerchantAccount
    events:
      - http:
          path: /payments/onboard
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  # Store Checkout (Split Payments)
  createStoreOrder:
    handler: src/checkout.createStoreOrder
    events:
      - http:
          path: /payments/checkout
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  # Platform Subscription (Merchant pays WebDPro)
  createSubscription:
    handler: src/subscription.createSubscription
    events:
      - http:
          path: /payments/subscription
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

  # Webhooks
  handleWebhook:
    handler: src/webhooks.handleWebhook
    events:
      - http:
          path: /payments/webhook
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false
          
  handleSubscriptionWebhook:
    handler: src/subscription.handleSubscriptionWebhook
    events:
      - http:
          path: /payments/webhook/subscription
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false

plugins:
  - serverless-plugin-typescript
